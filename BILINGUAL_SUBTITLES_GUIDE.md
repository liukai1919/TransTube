# 双语字幕功能使用指南

## 功能概述

本项目现在支持生成双语字幕，可以同时显示英文原文和中文翻译，有效解决以下问题：

1. **中英文同时显示**: 英文在上，中文在下的双行显示
2. **翻译质量优化**: 对翻译失败的字幕自动保留英文原文
3. **智能字幕检测**: 自动识别单语和双语字幕，优化显示样式

## 主要改进

### 1. 双语字幕合并功能 (`bilingual_subtitle_merger.py`)

- **`create_bilingual_content()`**: 创建双语字幕内容格式
- **`validate_translation()`**: 验证翻译质量，处理翻译失败情况
- **`merge_bilingual_subtitles()`**: 合并英文和中文字幕文件
- **`create_bilingual_subtitles_from_translation()`**: 从翻译结果创建双语字幕

### 2. 字幕烧录优化 (`subtitle_embedder.py`)

- **双语字幕检测**: 自动识别字幕文件是否为双语
- **样式优化**: 双语字幕使用较小字体和更大边距
- **字体支持**: 支持中英文混合显示的字体配置

### 3. 翻译质量改进 (`translator.py`)

- **单条翻译验证**: 对每条翻译结果进行质量检查
- **失败处理**: 翻译失败时自动保留英文原文
- **双语字幕生成**: 新增 `translate_srt_to_bilingual()` 函数

### 4. 主流程更新 (`main.py`)

- **视频处理流程**: 默认生成双语字幕而非纯中文字幕
- **API端点**: 下载字幕API也支持双语字幕生成

## 使用方式

### 自动模式（推荐）

现在所有的视频处理都会自动生成双语字幕：

1. 上传视频或提供YouTube链接
2. 系统自动获取/转录英文字幕
3. 翻译成中文并生成双语字幕
4. 烧录到视频中，英文在上，中文在下

### 手动调用

如果需要单独使用双语字幕功能：

```python
from backend.utils.translator import translate_srt_to_bilingual
from backend.utils.bilingual_subtitle_merger import merge_bilingual_subtitles

# 方法1: 从英文字幕直接生成双语字幕
bilingual_srt = translate_srt_to_bilingual("english.srt", "zh")

# 方法2: 合并已有的英文和中文字幕
bilingual_srt = merge_bilingual_subtitles("english.srt", "chinese.srt")
```

## 显示效果

### 双语字幕格式示例

```
1
00:00:01,000 --> 00:00:03,000
Hello, world!
你好，世界！

2
00:00:04,000 --> 00:00:06,000
This is a test.
这是一个测试。

3
00:00:07,000 --> 00:00:09,000
How are you today?
你今天怎么样？
```

### 翻译失败处理

如果某条字幕翻译失败，会显示两行英文：

```
4
00:00:10,000 --> 00:00:12,000
Complex technical term
Complex technical term
```

## 技术特性

### 翻译质量检查

系统会自动检查翻译质量，在以下情况下保留英文原文：

- 翻译结果为空
- 翻译结果不包含中文字符
- 翻译结果与原文完全相同
- 包含明显的翻译失败标志词

### 字幕样式优化

双语字幕使用专门优化的显示样式：

- 字体大小：比单语字幕小15%
- 底部边距：增加50%以容纳双行文本
- 字体配置：支持中英文混合显示
- 行间距：适当增加以提高可读性

### 自动检测功能

系统可以自动检测字幕文件类型：

- 检查是否同时包含中英文字符
- 分析是否有多行字幕条目
- 自动选择合适的显示样式

## 文件变更说明

### 新增文件

- `backend/utils/bilingual_subtitle_merger.py`: 双语字幕合并核心功能

### 修改文件

- `backend/utils/subtitle_embedder.py`: 添加双语字幕检测和样式优化
- `backend/utils/translator.py`: 改进翻译质量验证和双语字幕生成
- `backend/main.py`: 更新主处理流程使用双语字幕

### 输出文件变更

- 字幕文件后缀从 `*_zh.srt` 改为 `*_bilingual.srt`
- 视频文件仍然是 `*_sub.mp4`

## 兼容性

- 完全向后兼容现有的API接口
- 现有的单语字幕功能仍然可用
- 自动检测字幕类型，无需手动配置

## 故障排除

### 常见问题

1. **翻译服务不可用**: 系统会自动回退到英文原文
2. **字体显示问题**: 确保系统安装了中文字体
3. **字幕时间不同步**: 双语字幕使用英文字幕的时间轴为准

### 日志信息

系统会记录详细的处理日志：

- 字幕检测结果（中文/英文/多行条目/双语判断）
- 翻译质量验证信息
- 双语字幕生成状态

## 性能影响

- 翻译时间：与原来相同（仍需要翻译步骤）
- 烧录时间：略有增加（双行文本渲染）
- 文件大小：字幕文件略大，视频文件基本无变化

---

通过这些优化，现在您的视频将自动生成高质量的双语字幕，既保留了英文原文的准确性，又提供了中文翻译的便利性。对于翻译质量不佳的部分，系统会智能地保留英文原文，确保字幕内容的完整性和准确性。